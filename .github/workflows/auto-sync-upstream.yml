name: Auto-sync with upstream Hyprland
on:
  schedule:
    - cron: '0 0 * * *'  # Fixed the cron syntax (was * **)
  workflow_dispatch:

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    outputs:
      has_changes: ${{ steps.sync.outputs.has_changes }}
      version: ${{ steps.sync.outputs.version }}
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git cmake ninja pkg-config wayland wayland-protocols libxkbcommon pixman glslang vulkan-headers vulkan-validation-layers libdrm mesa

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Check and sync upstream
        id: sync
        run: |
          echo "Checking upstream..."
          git remote add upstream https://github.com/hyprwm/Hyprland.git
          git fetch upstream
          
          UPSTREAM_HASH=$(git rev-parse upstream/main)
          CURRENT_HASH=$(git rev-parse HEAD)
          
          if [ "$UPSTREAM_HASH" != "$CURRENT_HASH" ]; then
            echo "New changes found"
            if git merge upstream/main --no-edit; then
              git push origin main
              NEW_VERSION=$(date +"%Y.%m.%d")-$(echo $UPSTREAM_HASH | cut -c1-8)
              echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              git merge --abort
              echo "has_changes=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create PKGBUILD
        if: steps.sync.outputs.has_changes == 'true'
        run: |
          cat > PKGBUILD << 'EOF'
          pkgname=hyprland-fork
          pkgver=${{ steps.sync.outputs.version }}
          pkgrel=1
          pkgdesc="A dynamic tiling Wayland compositor - Custom Fork"
          arch=('x86_64')
          url="https://github.com/Stayroh/Hyprland_Tweaks"
          license=('BSD')
          depends=('wayland' 'wayland-protocols' 'libxkbcommon' 'pixman' 'glslang' 'vulkan-validation-layers' 'libdrm' 'mesa')
          makedepends=('git' 'cmake' 'ninja' 'vulkan-headers')
          source=("git+https://github.com/Stayroh/Hyprland_Tweaks.git#commit=${{ github.sha }}")
          sha256sums=('SKIP')

          build() {
            cd "$srcdir/Hyprland_Tweaks"
            make all
          }

          package() {
            cd "$srcdir/Hyprland_Tweaks"
            make install DESTDIR="$pkgdir"
          }
          EOF

      - name: Build package
        if: steps.sync.outputs.has_changes == 'true'
        run: |
          useradd -m builder
          chown -R builder:builder .
          sudo -u builder makepkg -s --noconfirm

      - name: Create release and upload package
        if: steps.sync.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.sync.outputs.version }}
          name: Hyprland Fork v${{ steps.sync.outputs.version }}
          body: |
            Auto-generated release with upstream sync
            Upstream commit: ${{ github.sha }}
          files: |
            *.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
