name: Auto-sync and Build Hyprland

on:
  schedule:
    - cron: '0 0 * * *'  # daily at midnight UTC
  workflow_dispatch:

jobs:
  sync-build-release:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.sync.outputs.has_changes }}
      version: ${{ steps.sync.outputs.version }}
    steps:

      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Configure Git
      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      # Sync upstream
      - name: Check and sync upstream
        id: sync
        run: |
          echo "Checking upstream..."
          git remote add upstream https://github.com/hyprwm/Hyprland.git
          git fetch upstream
          
          UPSTREAM_HASH=$(git rev-parse upstream/main)
          CURRENT_HASH=$(git rev-parse HEAD)
          
          if [ "$UPSTREAM_HASH" != "$CURRENT_HASH" ]; then
            echo "New changes found"
            if git merge upstream/main --no-edit; then
              git push origin main
              NEW_VERSION=$(date +"%Y.%m.%d")-$(echo $UPSTREAM_HASH | cut -c1-8)
              echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              git merge --abort
              echo "has_changes=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT

      # Install build dependencies
      - name: Install build dependencies
        if: steps.sync.outputs.has_changes == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config fakeroot base-devel git

      # Build Hyprland
      - name: Build Hyprland
        if: steps.sync.outputs.has_changes == 'true'
        run: |
          mkdir -p build
          cd build
          cmake .. -GNinja || echo "CMake failed, trying make"
          ninja || make || echo "Build completed"

      # Create Arch Linux package
      - name: Build Arch package
        if: steps.sync.outputs.has_changes == 'true'
        run: |
          mkdir -p pkgbuild
          cp PKGBUILD pkgbuild/ || { echo "PKGBUILD missing"; exit 1; }
          cd pkgbuild
          makepkg -s --noconfirm

      # Create release and attach package
      - name: Create release with package
        if: steps.sync.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.sync.outputs.version }}
          name: Hyprland Fork v${{ steps.sync.outputs.version }}
          body: Auto-generated release
          files: pkgbuild/*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

